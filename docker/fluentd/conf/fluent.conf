# ============================================================================
# KATMALL - FLUENTD CONFIGURATION
# Author: tai.buivan@outlook.com
# Description: Log aggregation and forwarding configuration
# ============================================================================

# ============================================================================
# SOURCE: NGINX ACCESS LOGS
# ============================================================================
<source>
  @type tail
  @id nginx_access
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx-access.log.pos
  tag nginx.access
  read_from_head true
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S%z
  </parse>
</source>

# ============================================================================
# SOURCE: NGINX ERROR LOGS
# ============================================================================
<source>
  @type tail
  @id nginx_error
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx-error.log.pos
  tag nginx.error
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)$/
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

# ============================================================================
# SOURCE: SPRING BOOT APPLICATION LOGS (via Docker log driver)
# ============================================================================
<source>
  @type forward
  @id app_logs
  port 24224
  bind 0.0.0.0
</source>

# ============================================================================
# FILTER: ADD METADATA
# ============================================================================
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment "#{ENV['ENVIRONMENT'] || 'development'}"
    application "katmall"
  </record>
</filter>

# ============================================================================
# FILTER: PARSE SPRING BOOT JSON LOGS
# ============================================================================
<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true
  <parse>
    @type json
    json_parser oj
  </parse>
</filter>

# ============================================================================
# OUTPUT: CONSOLE (for development)
# ============================================================================
<match **>
  @type copy
  
  # Console output (development)
  <store>
    @type stdout
    <format>
      @type json
    </format>
  </store>
  
  # File output (persistent storage)
  <store>
    @type file
    @id output_file
    path /var/log/fluentd/katmall
    append true
    <format>
      @type json
    </format>
    <buffer time>
      @type file
      path /var/log/fluentd/buffer
      timekey 1d
      timekey_wait 10m
      flush_mode interval
      flush_interval 60s
    </buffer>
  </store>
  
  # Uncomment for Elasticsearch output
  # <store>
  #   @type elasticsearch
  #   host elasticsearch
  #   port 9200
  #   logstash_format true
  #   logstash_prefix katmall
  #   include_timestamp true
  #   <buffer>
  #     @type file
  #     path /var/log/fluentd/es-buffer
  #     flush_mode interval
  #     flush_interval 5s
  #     retry_type exponential_backoff
  #   </buffer>
  # </store>
</match>
